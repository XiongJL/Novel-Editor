generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Novel {
  id          String   @id @default(cuid())
  title       String
  description String?
  coverUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  version     Int      @default(1)
  deleted     Boolean  @default(false)

  wordCount   Int      @default(0)
  formatting  String   @default("{}") // JSON: { "volume": "...", "chapter": "..." }

  volumes    Volume[]
  characters Character[]
  items      Item[]
  ideas      Idea[]
  tags       Tag[]
  plotLines  PlotLine[]
  plotPoints PlotPoint[]
  worldSettings WorldSetting[]
}

model Volume {
  id      String @id @default(cuid())
  title   String
  order   Int
  novelId String
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  version     Int      @default(1)
  deleted     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chapters Chapter[]
}

model Chapter {
  id       String @id @default(cuid())
  title    String
  content  String
  wordCount Int @default(0)
  order    Int
  volumeId String
  volume   Volume @relation(fields: [volumeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version     Int      @default(1)
  deleted     Boolean  @default(false)
  
  ideas Idea[]
  anchors PlotPointAnchor[]
}

model SyncState {
  id        String   @id @default("global") 
  cursor    BigInt   @default(0)
  updatedAt DateTime @updatedAt
}

model Character {
  id          String  @id @default(cuid())
  name        String
  role        String? // 主角, 配角, 反派...
  avatar      String? // Base64 or file path
  description String? // 简介
  profile     String  @default("{}") // JSON: 自定义属性 { "年龄": "18", "生日": "1月1日" }
  sortOrder   Float   @default(0)
  isStarred   Boolean @default(false)

  novelId String
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)

  items     ItemOwnership[]
  relationsAsSource Relationship[] @relation("RelationSource")
  relationsAsTarget Relationship[] @relation("RelationTarget")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Item {
  id          String  @id @default(cuid())
  name        String
  type        String  @default("item") // 'item' | 'skill' | 'location'
  icon        String? // emoji or icon name
  description String?
  profile     String  @default("{}") // JSON: 自定义属性

  novelId     String
  novel       Novel   @relation(fields: [novelId], references: [id], onDelete: Cascade)

  sortOrder   Float   @default(0)
  owners      ItemOwnership[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ItemOwnership {
  id          String    @id @default(cuid())
  characterId String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  itemId      String
  item        Item      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  note        String?   // 备注 (如 "已损坏")
  createdAt   DateTime  @default(now())

  @@unique([characterId, itemId])
}

model WorldSetting {
  id          String   @id @default(cuid())
  name        String
  content     String   @default("") // Rich text content
  type        String   @default("other") // 'history' | 'geography' | 'magic_system' | 'faction' | 'technology' | 'other'
  icon        String?  // Custom icon name
  sortOrder   Float    @default(0)

  novelId     String
  novel       Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Relationship {
  id          String    @id @default(cuid())
  sourceId    String
  source      Character @relation("RelationSource", fields: [sourceId], references: [id], onDelete: Cascade)
  targetId    String
  target      Character @relation("RelationTarget", fields: [targetId], references: [id], onDelete: Cascade)
  relation    String    // 关系名称, e.g. "父亲", "敌对", "师徒"
  description String?   // 关系详细描述

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([sourceId, targetId])
}

model Idea {
  id        String   @id @default(cuid())
  content   String
  quote     String?  // 选中的原文 (可选)
  cursor    String?  // 游标/定位信息 (可选)
  isStarred Boolean  @default(false)
  tags      Tag[]
  
  novelId   String
  novel     Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  chapterId String?  // 关联章节 (可选)
  chapter   Chapter? @relation(fields: [chapterId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Tag {
  id      String @id @default(cuid())
  name    String
  novelId String
  novel   Novel  @relation(fields: [novelId], references: [id], onDelete: Cascade)
  ideas   Idea[]

  @@unique([name, novelId])
}

model PlotLine {
  id          String   @id @default(cuid())
  novelId     String
  novel       Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  name        String
  description String?
  color       String   // Hex color code
  
  points      PlotPoint[]
  
  sortOrder   Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PlotPoint {
  id          String   @id @default(cuid())
  novelId     String
  novel       Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  
  plotLineId  String
  plotLine    PlotLine @relation(fields: [plotLineId], references: [id], onDelete: Cascade)
  
  title       String
  description String?
  type        String   // 'foreshadowing' | 'mystery' | 'promise' | 'event'
  status      String   // 'active' | 'resolved'
  icon        String?  // Custom icon name (e.g. from Lucide)
  
  order       Float    @default(0)
  
  anchors     PlotPointAnchor[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PlotPointAnchor {
  id          String   @id @default(cuid())
  plotPointId String
  plotPoint   PlotPoint @relation(fields: [plotPointId], references: [id], onDelete: Cascade)
  
  chapterId   String
  chapter     Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  
  type        String    // 'setup' | 'payoff'
  
  lexicalKey  String?   // Key of the node in Lexical
  offset      Int?      // Character offset
  length      Int?      // Length of selection
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
